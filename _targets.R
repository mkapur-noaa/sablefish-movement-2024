# Load targets package
library(targets)

# Source scripts in R/
source("R/plot.R")
source("R/recenter.R")
source("R/utils.R")

# Set options
tar_option_set(
  packages = c(
    "dplyr",
    "fs",
    "ggraph",
    "ggplot2",
    "ggpubr",
    "ggsidekick",
    "ggspatial",
    "here",
    "magrittr",
    "mmmstan",
    "readr",
    "rlang",
    "rnaturalearth",
    "rnaturalearthdata",
    "sf",
    "tictoc",
    "tidygraph",
    "tidyr",
    "usethis"
  )
)
options(tidyverse.quiet = TRUE)

# List target objects
list(
  # Define figure options ------------------------------------------------------
  list(
    tar_target(figure_dpi, 600),
    tar_target(figure_ext, ".png")
  ),
  # Define table options -------------------------------------------------------
  list(
    tar_target(table_digits, 2)
  ),
  # Define years ---------------------------------------------------------------
  list(
    tar_target(year_start, 1979), # Year of first tag released
    tar_target(year_end, 2017), # Year of last tag recovered
    list()
  ),
  # Define regions -------------------------------------------------------------
  list(
    tar_target(
      list_regions_3,
      list(ak = 1, bc = 2, cc = 3)
    ),
    tar_target(
      list_regions_6,
      list(wak = 1, eak = 2, nbc = 3, sbc = 4, ncc = 5, scc = 6)
    ),
    tar_target(
      list_regions_8,
      list(ai = 1, bs = 2, wg = 3, cg = 4, eg = 5, se = 6, bc = 7, cc = 8)
    )
  ),
  # Define sizes ---------------------------------------------------------------
  list(
    tar_target(list_sizes_1, list(sml = 400:800)),
    tar_target(list_sizes_2, list(s = 400:549, l = 550:800)),
    list()
  ),
  # Define model step and term -------------------------------------------------
  list(
    tar_target(step_interval, "quarter"),
    tar_target(step_duration_max, 12L), # Max duration at large before recovery
    list()
  ),
  # Define minimum duration for tag mixing before recovery ---------------------
  list(
    tar_target(days_duration_min, 180),
    list()
  ),
  # Column name arguments ------------------------------------------------------
  list(
    tar_target(colname_date_released, "date_released"),
    tar_target(colname_date_recovered, "date_recovered"),
    tar_target(colname_region_released_3, "region_released_3"),
    tar_target(colname_region_released_6, "region_released_6"),
    tar_target(colname_region_released_8, "region_released_8"),
    tar_target(colname_region_recovered_3, "region_recovered_3"),
    tar_target(colname_region_recovered_6, "region_recovered_6"),
    tar_target(colname_region_recovered_8, "region_recovered_8"),
    tar_target(colname_size_released, "size_released"),
    list()
  ),
  # Define movement step diagonal priors ---------------------------------------
  list(
    tar_target(mu_movement_step_diag_3, rep(0.98, 3)),
    tar_target(sd_movement_step_diag_3, rep(0.05, 3)),
    tar_target(mu_movement_step_diag_6, rep(0.98, 6)),
    tar_target(sd_movement_step_diag_6, rep(0.05, 6)),
    tar_target(mu_movement_step_diag_8, rep(0.98, 8)),
    tar_target(sd_movement_step_diag_8, rep(0.05, 8))
  ),
  # Define reporting rate priors -----------------------------------------------
  list(
    tar_target(mu_reporting_rate_3, c(0.4, 0.5, 0.3)),
    tar_target(sd_reporting_rate_3, c(0.4, 0.5, 0.3) * 0.1),
    tar_target(mu_reporting_rate_6, c(0.4, 0.4, 0.5, 0.5, 0.3, 0.3)),
    tar_target(sd_reporting_rate_6, c(0.4, 0.4, 0.5, 0.5, 0.3, 0.3) * 0.1),
    tar_target(mu_reporting_rate_8, c(rep(0.4, 6), 0.5, 0.3)),
    tar_target(sd_reporting_rate_8, c(rep(0.4, 6), 0.5, 0.3) * 0.1)
  ),
  # Define selectivity priors --------------------------------------------------
  list(
    tar_target(mu_selectivity_3, array(rep(c(0.9, 1), 3), dim = c(2, 3))),
    tar_target(mu_selectivity_6, array(rep(c(0.9, 1), 6), dim = c(2, 6))),
    tar_target(cv_selectivity, 0.1)
  ),
  # Define natural mortality rate priors ---------------------------------------
  list(
    tar_target(mu_natural_mortality_rate_3, rep(0.1, 3)),
    tar_target(sd_natural_mortality_rate_3, rep(0.01, 3)),
    tar_target(mu_natural_mortality_rate_6, rep(0.1, 6)),
    tar_target(sd_natural_mortality_rate_6, rep(0.01, 6)),
    tar_target(mu_natural_mortality_rate_8, rep(0.1, 8)),
    tar_target(sd_natural_mortality_rate_8, rep(0.01, 8))
  ),
  # Define shared priors -------------------------------------------------------
  list(
    tar_target(mu_initial_loss_rate, 0.1),
    tar_target(sd_initial_loss_rate, 0.01),
    tar_target(mu_ongoing_loss_rate, 0.02),
    tar_target(sd_ongoing_loss_rate, 0.001),
    tar_target(mu_dispersion, 1.0),
    tar_target(sd_dispersion, 0.5)
  ),
  # Define tolerance arguments -------------------------------------------------
  list(
    tar_target(tolerance_expected, 1e-12),
    tar_target(tolerance_fishing, 1e-12)
  ),
  # Define CmdStanR arguments --------------------------------------------------
  list(
    tar_target(chains, 3),
    tar_target(step_size, 0.01),
    tar_target(adapt_delta, 0.95),
    tar_target(iter_warmup, 250),
    tar_target(iter_sampling, 1000),
    tar_target(max_treedepth, 10),
    tar_target(use_reduce_sum, TRUE),
    tar_target(threads_per_chain, parallel::detectCores() / (2 * chains)),
    tar_target(refresh, 10)
  ),
  # Watch data -----------------------------------------------------------------
  list(
    tar_target(
      watch_tag_data,
      "data/tag_data.rda",
      format = "file"
    ),
    tar_target(
      watch_fishing_rate,
      "data/fishing_rate.rda",
      format = "file"
    ),
    tar_target(
      watch_abundance,
      "data/abundance.rda",
      format = "file"
    ),
    tar_target(
      watch_sf_regions_6,
      "data/sf_regions_6.rda",
      format = "file"
    ),
    tar_target(
      watch_sf_regions_8,
      "data/sf_regions_8.rda",
      format = "file"
    ),
    list()
  ),
  # Read data ------------------------------------------------------------------
  list(
    tar_target(tag_data, read_from_path(watch_tag_data)),
    tar_target(abundance, read_from_path(watch_abundance)),
    tar_target(sf_regions_6, read_from_path(watch_sf_regions_6)),
    tar_target(sf_regions_8, read_from_path(watch_sf_regions_8)),
    list()
  ),
  # Assemble tag data no recovery transition -----------------------------------
  list(
    tar_target(
      tag_data_no_recovery_transition, # Caution: filtering tags recovered only
      tag_data %>%                     # Lose about 16 % of recovered
        dplyr::filter(                 # And no corresponding loss of released
          ((size_released %in% c(400:549, NA)) &
             (size_recovered %in% c(400:549, NA))) |
            ((size_released %in% c(550:800, NA)) &
               (size_recovered %in% c(550:800, NA)))
        )
    )
  ),
  # Assemble fishing rate priors -----------------------------------------------
  list(
    # Regions 3
    tar_target(
      mu_fishing_rate_3,
      read_from_path(watch_fishing_rate) %>%
        dplyr::filter(spatial == "regions_3") %>%
        dplyr::filter(year %in% c(year_start:year_end)) %>%
        dplyr::select(year, short, fishing_rate) %>%
        dplyr::mutate(short = tolower(short)) %>%
        tidyr::pivot_wider(
          names_from = short,
          values_from = fishing_rate
        ) %>%
        dplyr::select(-1L) %>%
        as.matrix()
    ),
    # Regions 6
    tar_target(
      mu_fishing_rate_6,
      read_from_path(watch_fishing_rate) %>%
        dplyr::filter(spatial == "regions_6") %>%
        dplyr::filter(year %in% c(year_start:year_end)) %>%
        dplyr::select(year, short, fishing_rate) %>%
        dplyr::mutate(short = tolower(short)) %>%
        tidyr::pivot_wider(
          names_from = .data$short,
          values_from = .data$fishing_rate
        ) %>%
        dplyr::select(-1L) %>%
        as.matrix()
    ),
    # Regions 8
    tar_target(
      mu_fishing_rate_8,
      read_from_path(watch_fishing_rate) %>%
        dplyr::filter(spatial == "regions_8") %>%
        dplyr::filter(year %in% c(year_start:year_end)) %>%
        dplyr::select(year, short, fishing_rate) %>%
        dplyr::mutate(short = tolower(short)) %>%
        tidyr::pivot_wider(
          names_from = .data$short,
          values_from = .data$fishing_rate
        ) %>%
        dplyr::select(-1L) %>%
        as.matrix()
    ),
    # CV
    tar_target(cv_fishing_rate, 0.1)
  ),
  # Plot map regions 6 ---------------------------------------------------------
  list(
    tar_target(
      map_regions_6,
      plot_map(
        regions = sf_regions_6,
        plot_name = "map-regions-6",
        colname_regions_short = "region_short_6",
        size_short = 1.75,
        size_line = 0.25,
        size_text = 5,
        color_land = "white",
        color_ocean = "grey96",
        color_region = "grey30",
        fill_land = "white",
        fill_ocean = "grey95",
        fill_region = "grey85",
        xmin = 169,
        ymin = 31,
        xmax = 240.5,
        ymax = 65.5,
        width = 90,
        height = 65,
        dpi = figure_dpi,
        file_type = figure_ext
      ),
      format = "file"
    )
  ),
  # Plot map regions 8 ---------------------------------------------------------
  list(
    tar_target(
      map_regions_8,
      plot_map(
        regions = sf_regions_8,
        plot_name = "map-regions-8",
        colname_regions_short = "region_short_8",
        size_short = 1.75,
        size_line = 0.25,
        size_text = 5,
        color_land = "white",
        color_ocean = "grey96",
        color_region = "grey30",
        fill_land = "white",
        fill_ocean = "grey95",
        fill_region = "grey85",
        nudge_x = c(0, 0, 0, 0, 0, 0, 0, -1),
        nudge_y = c(0, 0, 0, -1, 0.5, 0.25, 0, 0.25),
        xmin = 169,
        ymin = 31,
        xmax = 240.5,
        ymax = 65.5,
        width = 90,
        height = 65,
        dpi = figure_dpi,
        file_type = figure_ext
      ),
      format = "file"
    )
  ),
  # Fit regions 3 mean ---------------------------------------------------------
  list(
    tar_target(
      mmmstan_regions_3_mean, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_1, #
        year_start = year_start,
        year_end = year_end,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_3, #
        colname_region_recovered = colname_region_recovered_3, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3, #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = NULL, #
        cv_selectivity = NULL, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit regions 6 mean ---------------------------------------------------------
  list(
    tar_target(
      mmmstan_regions_6_mean, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_6, #
        list_sizes = list_sizes_1, #
        year_start = year_start,
        year_end = year_end,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_6, #
        colname_region_recovered = colname_region_recovered_6, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_6, #
        sd_movement_step_diag = sd_movement_step_diag_6, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_6, #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = NULL, #
        cv_selectivity = NULL, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_6, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_6, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_6, #
        sd_reporting_rate = sd_reporting_rate_6, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit regions 8 mean ---------------------------------------------------------
  list(
    tar_target(
      mmmstan_regions_8_mean, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_8, #
        list_sizes = list_sizes_1, #
        year_start = year_start,
        year_end = year_end,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_8, #
        colname_region_recovered = colname_region_recovered_8, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = matrix(c(5, 7, 7, 5), nrow = 2, byrow = TRUE), #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_8, #
        sd_movement_step_diag = sd_movement_step_diag_8, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_8, #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = NULL, #
        cv_selectivity = NULL, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_8, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_8, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_8, #
        sd_reporting_rate = sd_reporting_rate_8, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit regions 3 size ---------------------------------------------------------
  list(
    tar_target(
      mmmstan_regions_3_size, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_2, #
        year_start = year_start,
        year_end = year_end,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_8, #
        colname_region_recovered = colname_region_recovered_8, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3, #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = mu_selectivity_3, #
        cv_selectivity = cv_selectivity, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit regions 3 mean block 1979-1994 -----------------------------------------
  list(
    tar_target(
      mmmstan_regions_3_mean_block_1979_1994, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_1, #
        year_start = 1979,
        year_end = 1994,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_3, #
        colname_region_recovered = colname_region_recovered_3, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3[1:16,], #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = NULL, #
        cv_selectivity = NULL, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit regions 3 mean block 1995-2006 -----------------------------------------
  list(
    tar_target(
      mmmstan_regions_3_mean_block_1995_2006, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_1, #
        year_start = 1995,
        year_end = 2006,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_3, #
        colname_region_recovered = colname_region_recovered_3, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3[17:28,], #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = NULL, #
        cv_selectivity = NULL, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit regions 3 mean block 2007-2017 -----------------------------------------
  list(
    tar_target(
      mmmstan_regions_3_mean_block_2007_2017, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_1, #
        year_start = 2007,
        year_end = 2017,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_3, #
        colname_region_recovered = colname_region_recovered_3, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3[29:39,], #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = NULL, #
        cv_selectivity = NULL, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit region 3 mean 3x cv_fishing_rate ---------------------------------------
  list(
    tar_target(
      mmmstan_regions_3_mean_3x_cv_fishing_rate, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_1, #
        year_start = year_start,
        year_end = year_end,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_3, #
        colname_region_recovered = colname_region_recovered_3, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3, #
        cv_fishing_rate = cv_fishing_rate * 3, #
        # Selectivity priors
        mu_selectivity = NULL, #
        cv_selectivity = NULL, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit region 3 mean 3x sd_reporting_rate -------------------------------------
  list(
    tar_target(
      mmmstan_regions_3_mean_3x_sd_reporting_rate, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_1, #
        year_start = year_start,
        year_end = year_end,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_3, #
        colname_region_recovered = colname_region_recovered_3, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3, #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = NULL, #
        cv_selectivity = NULL, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3 * 3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit regions 3 size no duration constraint ----------------------------------
  list(
    tar_target(
      mmmstan_regions_3_size_no_duration_constraint, #
      mmmstan::mmmstan(
        tag_data = tag_data,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_2, #
        year_start = year_start,
        year_end = year_end,
        step_interval = step_interval,
        step_duration_max = 42, # (2017 - 1979 + 1) x 4
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_3, #
        colname_region_recovered = colname_region_recovered_3, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3, #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = mu_selectivity_3, #
        cv_selectivity = cv_selectivity, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Fit regions 3 size no recovery transition ----------------------------------
  list(
    tar_target(
      mmmstan_regions_3_size_no_recovery_transition, #
      mmmstan::mmmstan(
        tag_data = tag_data_no_recovery_transition,
        # Tag arguments
        list_regions = list_regions_3, #
        list_sizes = list_sizes_2, #
        year_start = year_start,
        year_end = year_end,
        step_interval = step_interval,
        step_duration_max = step_duration_max,
        days_duration_min = days_duration_min,
        colname_date_released = colname_date_released,
        colname_date_recovered = colname_date_recovered,
        colname_region_released = colname_region_released_3, #
        colname_region_recovered = colname_region_recovered_3, #
        colname_size_released = colname_size_released,
        # Movement index
        movement_pattern = 2L, # See: ?mmmstan::create_movement_index()
        movement_allow = NULL, #
        movement_disallow = NULL, #
        # Movement step mean priors
        mu_movement_step_diag = mu_movement_step_diag_3, #
        sd_movement_step_diag = sd_movement_step_diag_3, #
        # Fishing rate priors
        mu_fishing_rate = mu_fishing_rate_3, #
        cv_fishing_rate = cv_fishing_rate,
        # Selectivity priors
        mu_selectivity = mu_selectivity_3, #
        cv_selectivity = cv_selectivity, #
        # Fishing weight priors
        mu_fishing_weight = NULL, # Not implemented
        sd_fishing_weight = NULL, # Not implemented
        # Natural mortality rate priors
        mu_natural_mortality_rate = mu_natural_mortality_rate_3, #
        sd_natural_mortality_rate = sd_natural_mortality_rate_3, #
        # Fractional (per tag) reporting rate priors
        mu_reporting_rate = mu_reporting_rate_3, #
        sd_reporting_rate = sd_reporting_rate_3, #
        # Fractional (per tag) initial loss rate priors
        mu_initial_loss_rate = mu_initial_loss_rate,
        sd_initial_loss_rate = sd_initial_loss_rate,
        # Instantaneous ongoing loss rate priors
        mu_ongoing_loss_rate = mu_ongoing_loss_rate,
        sd_ongoing_loss_rate = sd_ongoing_loss_rate,
        # Dispersion priors
        mu_dispersion = mu_dispersion,
        sd_dispersion = sd_dispersion,
        # Tolerance values
        tolerance_expected = tolerance_expected,
        tolerance_fishing = tolerance_fishing,
        # CmdStanR
        data = NULL,
        chains = chains,
        step_size = step_size,
        adapt_delta = adapt_delta,
        iter_warmup = iter_warmup,
        iter_sampling = iter_sampling,
        max_treedepth = max_treedepth,
        use_reduce_sum = use_reduce_sum,
        threads_per_chain = threads_per_chain,
        refresh = refresh
      )
    )
  ),
  # Write movement rate table csv files ----------------------------------------
  list(
    # Movement means
    tar_target(
      movement_rate_csv_regions_3_mean,
      write_movement_rate_csv(
        m = mmmstan_regions_3_mean$summary$movement_rate,
        name = "movement-rate-regions-3-mean",
        digits = table_digits,
        path = "ms/tabs"
      ),
      format = "file"
    ),
    tar_target(
      movement_rate_csv_regions_6_mean,
      write_movement_rate_csv(
        m = mmmstan_regions_6_mean$summary$movement_rate,
        name = "movement-rate-regions-6-mean",
        digits = table_digits,
        path = "ms/tabs"
      ),
      format = "file"
    ),
    tar_target(
      movement_rate_csv_regions_8_mean,
      write_movement_rate_csv(
        m = mmmstan_regions_8_mean$summary$movement_rate,
        name = "movement-rate-regions-8-mean",
        digits = table_digits,
        path = "ms/tabs"
      ),
      format = "file"
    ),
    # Movement blocks
    tar_target(
      movement_rate_csv_regions_3_mean_block_1979_1994,
      write_movement_rate_csv(
        m = mmmstan_regions_3_mean_block_1979_1994$summary$movement_rate,
        name = "movement-rate-regions-3-mean-block-1979-1994",
        digits = table_digits,
        path = "ms/tabs"
      ),
      format = "file"
    ),
    tar_target(
      movement_rate_csv_regions_3_mean_block_1995_2006,
      write_movement_rate_csv(
        m = mmmstan_regions_3_mean_block_1995_2006$summary$movement_rate,
        name = "movement-rate-regions-3-mean-block-1995-2006",
        digits = table_digits,
        path = "ms/tabs"
      ),
      format = "file"
    ),
    tar_target(
      movement_rate_csv_regions_3_mean_block_2007_2017,
      write_movement_rate_csv(
        m = mmmstan_regions_3_mean_block_2007_2017$summary$movement_rate,
        name = "movement-rate-regions-3-mean-block-2007-2017",
        digits = table_digits,
        path = "ms/tabs"
      ),
      format = "file"
    ),
    # Movement mean sensitivity
    tar_target(
      movement_rate_csv_regions_3_mean_3x_cv_fishing_rate,
      write_movement_rate_csv(
        m = mmmstan_regions_3_mean_3x_cv_fishing_rate$summary$movement_rate,
        name = "movement-rate-regions-3-mean-3x-cv-fishing-rate",
        digits = table_digits,
        path = "ms/tabs"
      ),
      format = "file"
    ),
    tar_target(
      movement_rate_csv_regions_3_mean_3x_sd_reporting_rate,
      write_movement_rate_csv(
        m = mmmstan_regions_3_mean_3x_sd_reporting_rate$summary$movement_rate,
        name = "movement-rate-regions-3-mean-3x-sd-reporting-rate",
        digits = table_digits,
        path = "ms/tabs"
      ),
      format = "file"
    ),
    list()
  ),
  # Create movement block list -------------------------------------------------
  list(
    tar_target(
      movement_block_list,
      list(
        mmmstan_regions_3_mean_block_1979_1994$summary$movement_rate,
        mmmstan_regions_3_mean_block_1995_2006$summary$movement_rate,
        mmmstan_regions_3_mean_block_2007_2017$summary$movement_rate
      )
    )
  ),
  # Create movement block index ------------------------------------------------
  list(
    tar_target(
      movement_block_index,
      list(
        c(1:16), # 1979--1994
        c(17:28), # 1995--2006
        c(29:39) # 2007--2017
      )
    )
  ),
  # Compute abundance exchange -------------------------------------------------
  list(
    tar_target(
      abundance_exchange,
      create_abundance_exchange(
        abundance = abundance,
        movement_list = movement_block_list,
        index_list = movement_block_index,
        years = c(1979:2017),
        n_draws = 1000
      )
    )
  ),
  # Compute percent attributable -----------------------------------------------
  list(
    tar_target(
      percent_attributable,
      create_percent_attributable(
        abundance = abundance,
        movement_list = movement_block_list,
        index_list = movement_block_index,
        years = c(1979:2017),
        n_draws = 1000
      )
    )
  ),
  # Define tex values ----------------------------------------------------------
  list(
    # Tag arrays (Regions 3)
    tar_target(
      tag_array_released,
      aperm(
        mmmstan_regions_3_mean$data$tags, # [N - 1, D, L, X, X]
        perm = c(4, 5, 3, 1, 2)           # [X, X, L, N - 1, D]
      )[,,,, 1, drop = TRUE]              # [X, X, N - 1]
    ),
    tar_target(
      tag_array_recovered,
      aperm(
        mmmstan_regions_3_mean$data$tags,       # [N - 1, D, L, X, X]
        perm = c(4, 5, 3, 1, 2)                 # [X, X, L, N - 1, D]
      )[,,,, 2:step_duration_max, drop = TRUE]  # [X, X, N - 1, D - 1]
    ),
    # Data values (as used in model)
    tar_target(
      n_released,
      sum(tag_array_released)
    ),
    tar_target(
      n_released_ak,
      sum(tag_array_released[1, 1, ])
    ),
    tar_target(
      n_released_bc,
      sum(tag_array_released[2, 2, ])
    ),
    tar_target(
      n_released_cc,
      sum(tag_array_released[3, 3, ])
    ),
    tar_target(
      n_recovered,
      sum(tag_array_recovered)
    ),
    tar_target(
      n_recovered_ak, # Number recovered from AK release
      sum(tag_array_recovered[1,,,])
    ),
    tar_target(
      n_recovered_bc, # Number recovered from BC release
      sum(tag_array_recovered[2,,,])
    ),
    tar_target(
      n_recovered_cc, # Number recovered from CC release
      sum(tag_array_recovered[3,,,])
    ),
    # Data values (from raw data)
    tar_target(
      n_released_raw,
      tag_data %>%
        nrow()
    ),
    tar_target(
      n_released_ak_raw,
      tag_data %>%
        dplyr::filter(region_released_3 == 1) %>%
        nrow()
    ),
    tar_target(
      n_released_bc_raw,
      tag_data %>%
        dplyr::filter(region_released_3 == 2) %>%
        nrow()
    ),
    tar_target(
      n_released_cc_raw,
      tag_data %>%
        dplyr::filter(region_released_3 == 3) %>%
        nrow()
    ),
    tar_target(
      n_recovered_raw,
      tag_data %>%
        tidyr::drop_na(region_recovered_3) %>%
        nrow()
    ),
    tar_target(
      n_recovered_ak_raw,
      tag_data %>%
        dplyr::filter(region_released_3 == 1) %>%
        tidyr::drop_na(region_recovered_3) %>%
        nrow()
    ),
    tar_target(
      n_recovered_bc_raw,
      tag_data %>%
        dplyr::filter(region_released_3 == 2) %>%
        tidyr::drop_na(region_recovered_3) %>%
        nrow()
    ),
    tar_target(
      n_recovered_cc_raw,
      tag_data %>%
        dplyr::filter(region_released_3 == 3) %>%
        tidyr::drop_na(region_recovered_3) %>%
        nrow()
    ),
    tar_target(
      days_duration_min_raw,
      tag_data %>%
        dplyr::pull(days_liberty) %>%
        min(na.rm = TRUE)
    ),
    tar_target(
      days_duration_mean_raw,
      tag_data %>%
        dplyr::pull(days_liberty) %>%
        mean(na.rm = TRUE) %>%
        round()
    ),
    tar_target(
      days_duration_max_raw,
      tag_data %>%
        dplyr::pull(days_liberty) %>%
        max(na.rm = TRUE)
    ),
    tar_target(
      distance_min_raw,
      tag_data %>%
        dplyr::pull(tag_distance) %>%
        min(na.rm = TRUE) %>%
        magrittr::divide_by(1000) %>% # km
        round()
    ),
    tar_target(
      distance_mean_raw,
      tag_data %>%
        dplyr::pull(tag_distance) %>%
        mean(na.rm = TRUE)%>%
        magrittr::divide_by(1000) %>% # km
        round()
    ),
    tar_target(
      distance_max_raw,
      tag_data %>%
        dplyr::pull(tag_distance) %>%
        max(na.rm = TRUE)%>%
        magrittr::divide_by(1000) %>% # km
        round()
    ),
    # Data values (constraints imposed)
    tar_target(
      released_size_min,
      min(list_sizes_1$sml)
    ),
    tar_target(
      released_size_max,
      max(list_sizes_1$sml)
    ),
    tar_target(
      released_size_small_min,
      min(list_sizes_2$s)
    ),
    tar_target(
      released_size_small_max,
      max(list_sizes_2$s)
    ),
    tar_target(
      released_size_large_min,
      min(list_sizes_2$l)
    ),
    tar_target(
      released_size_large_max,
      max(list_sizes_2$l)
    ),
    list()
  ),
  # Write tex values -----------------------------------------------------------
  list(
    tar_target(
      values_tex,
      write_values_tex(
        # Note: no underscores permitted in TeX macro names
        name_value_list = list(
          # Analysis values
          yearStart = year_start,
          yearEnd = year_end,
          nYears = year_end - year_start + 1,
          nRegionsThree = length(list_regions_3),
          nRegionsSix = length(list_regions_6),
          nRegionsEight = length(list_regions_8),
          # Data values (as used in model)
          nReleased = n_released,
          nReleasedAK = n_released_ak,
          nReleasedBC = n_released_bc,
          nReleasedCC = n_released_cc,
          nRecovered = n_recovered,
          nRecoveredAK = n_recovered_ak, # Recovered from AK release
          nRecoveredBC = n_recovered_bc, # Recovered from BC release
          nRecoveredCC = n_recovered_cc, # Recovered from CC release
          # Data values (from raw data)
          nReleasedRaw = n_released_raw,
          nReleasedAKRaw = n_released_ak_raw,
          nReleasedBCRaw = n_released_bc_raw,
          nReleasedCCRaw = n_released_cc_raw,
          nRecoveredRaw = n_recovered_raw,
          nRecoveredAKRaw = n_recovered_ak_raw, # Recovered from AK release
          nRecoveredBCRaw = n_recovered_bc_raw, # Recovered from BC release
          nRecoveredCCRaw = n_recovered_cc_raw, # Recovered from CC release
          daysDurationMinRaw = days_duration_min_raw,
          daysDurationMeanRaw = days_duration_mean_raw,
          daysDurationMaxRaw = days_duration_max_raw,
          distanceMinRaw = distance_min_raw,
          distanceMeanRaw = distance_mean_raw,
          distanceMaxRaw = distance_max_raw,
          # Data values (constraints imposed)
          daysDurationMin = days_duration_min,
          releasedSizeMin = released_size_min,
          releasedSizeMax = released_size_max,
          releasedSizeSmallMin = released_size_small_min,
          releasedSizeSmallMax = released_size_small_max,
          releasedSizeLargeMin = released_size_large_min,
          releasedSizeLargeMax = released_size_large_max,
          # Prior values
          muNaturalMortality = mu_natural_mortality_rate_3[1],
          sdNaturalMortality = sd_natural_mortality_rate_3[1],
          muInitialLossRate = mu_initial_loss_rate,
          sdInitialLossRate = sd_initial_loss_rate,
          muOngoingLossRate = mu_ongoing_loss_rate,
          sdOngoingLossRate = sd_ongoing_loss_rate,
          muReportingRateAK = mu_reporting_rate_3[1],
          muReportingRateBC = mu_reporting_rate_3[2],
          muReportingRateCC = mu_reporting_rate_3[3],
          sdReportingRateAK = sd_reporting_rate_3[1],
          sdReportingRateBC = sd_reporting_rate_3[2],
          sdReportingRateCC = sd_reporting_rate_3[3],
          # Model values
          nChains = chains,
          stepSize = step_size,
          adaptDelta = adapt_delta,
          iterWarmup = iter_warmup,
          iterSampling = iter_sampling,
          maxTreedepth = max_treedepth,
          threadsPerChain = threads_per_chain
        ),
        path = file.path("ms", "vals"),
        filename = "values.tex",
        clear_first = TRUE
      ),
      format = "file"
    )
  ),
  # Plot map network regions 6 -------------------------------------------------
  list(
    tar_target(
      map_regions_6_network,
      plot_network(
        regions = sf_regions_6,
        rates = mmmstan_regions_6_mean$summary$movement_rate,
        plot_name = "map-regions-6-network",
        colname_regions_short = "region_short_6",
        size_short = 1.75,
        size_line = 0.25,
        size_text = 5,
        scale_edge_width_min = 0.2,
        scale_edge_width_max = 1.2,
        size_label = 3,
        hjust_label = c(0.5, 0.3, 1.1, -0.1, 1.5, -0.75, 1.15, -0.45, 1.5, 0.05),
        vjust_label = c(1.5, -0.55, 1.4, -2.3, 1.2, -0.15, 0, 1.7, 0, -0.4),
        strength = 4,
        color_land = "white",
        color_ocean = "grey96",
        color_region = "grey30",
        fill_land = "white",
        fill_ocean = "grey95",
        fill_region = "grey85",
        xmin = 169,
        ymin = 31,
        xmax = 240.5,
        ymax = 65.5,
        width = 90,
        height = 65,
        dpi = figure_dpi,
        file_type = figure_ext
      ),
      format = "file"
    )
  ),
  # Plot bar regions 3 size ----------------------------------------------------
  list(
    tar_target(
      bar_regions_3_size,
      plot_cols(
        data = mmmstan_regions_3_size$summary$movement_rate,
        plot_name = "bar-regions-3-size",
        regions = toupper(names(list_regions_3)),
        xvar = "l",
        xlab = "Length class",
        ylab = "Annual movement rate",
        x_text = c("Small", "Large"),
        x_breaks = 1:2,
        y_text = as.character(seq(0, 1, 0.25)),
        y_breaks = seq(0, 1, 0.25),
        x_angle = 0,
        hjust = 0.5,
        vjust = 0.5,
        size_title = 8,
        size_strip = 8,
        size_text = 6,
        size_error = 0.3,
        panel_spacing = 1,
        xmin = NA,
        xmax = NA,
        ymin = 0.0,
        ymax = 1.0,
        width = 190,
        height = 170,
        dpi = figure_dpi,
        file_type = figure_ext
      )
    ),
    format = "file"
  ),
  # Plot bar regions 3 size no duration constraint -----------------------------
  list(
    tar_target(
      bar_regions_3_size_no_duration_constraint,
      plot_cols(
        data = mmmstan_regions_3_size_no_duration_constraint$summary$movement_rate,
        plot_name = "bar-regions-3-size-no-duration-constraint",
        regions = toupper(names(list_regions_3)),
        xvar = "l",
        xlab = "Length class",
        ylab = "Annual movement rate",
        x_text = c("Small", "Large"),
        x_breaks = 1:2,
        y_text = as.character(seq(0, 1, 0.25)),
        y_breaks = seq(0, 1, 0.25),
        x_angle = 0,
        hjust = 0.5,
        vjust = 0.5,
        size_title = 8,
        size_strip = 8,
        size_text = 6,
        size_error = 0.3,
        panel_spacing = 1,
        xmin = NA,
        xmax = NA,
        ymin = 0.0,
        ymax = 1.0,
        width = 190,
        height = 170,
        dpi = figure_dpi,
        file_type = figure_ext
      )
    ),
    format = "file"
  ),
  # Plot bar regions 3 size no recovery transition -----------------------------
  list(
    tar_target(
      bar_regions_3_size_no_recovery_transition,
      plot_cols(
        data = mmmstan_regions_3_size_no_recovery_transition$summary$movement_rate,
        plot_name = "bar-regions-3-size-no-recovery-transition",
        regions = toupper(names(list_regions_3)),
        xvar = "l",
        xlab = "Length class",
        ylab = "Annual movement rate",
        x_text = c("Small", "Large"),
        x_breaks = 1:2,
        y_text = as.character(seq(0, 1, 0.25)),
        y_breaks = seq(0, 1, 0.25),
        x_angle = 0,
        hjust = 0.5,
        vjust = 0.5,
        size_title = 8,
        size_strip = 8,
        size_text = 6,
        size_error = 0.3,
        panel_spacing = 1,
        xmin = NA,
        xmax = NA,
        ymin = 0.0,
        ymax = 1.0,
        width = 190,
        height = 170,
        dpi = figure_dpi,
        file_type = figure_ext
      )
    ),
    format = "file"
  ),
  # Plot bar regions 3 fishing priors posteriors -------------------------------
  list(
    tar_target(
      bar_regions_3_fishing_priors_posteriors,
      plot_fishing_priors_posteriors(
        plot_name = "bar-regions-3-fishing-priors-posteriors",
        data_prior_means = mu_fishing_rate_3,
        data_prior_cv = cv_fishing_rate,
        data_posteriors = mmmstan_regions_3_mean$summary$fishing_rate,
        year_start = year_start,
        year_xmin = year_start,
        year_xmax = 2020,
        regions = toupper(names(list_regions_3)),
        bar_width = 0.75,
        position_dodge = 0.8,
        width = 190,
        height = 100,
        dpi = 300,
        file_type = ".png"
      ),
      format = "file"
    )
  ),
  # Plot bar regions 3 mortality priors posteriors -----------------------------
  list(
    tar_target(
      bar_regions_3_mortality_priors_posteriors,
      plot_mortality_priors_posteriors(
        plot_name = "bar-regions-3-mortality-priors-posteriors",
        data_prior_means = mu_natural_mortality_rate_3,
        data_prior_sd = sd_natural_mortality_rate_3,
        data_posteriors = mmmstan_regions_3_mean$summary$natural_mortality_rate,
        regions = toupper(names(list_regions_3)),
        bar_width = 0.75,
        position_dodge = 0.8,
        width = 90,
        height = 60,
        dpi = 300,
        file_type = ".png"
      ),
      format = "file"
    )
  ),
  # Plot bar regions 3 reporting priors posteriors -----------------------------
  list(
    tar_target(
      bar_regions_3_reporting_priors_posteriors,
      plot_reporting_priors_posteriors(
        plot_name = "bar-regions-3-reporting-priors-posteriors",
        data_prior_means = mu_reporting_rate_3,
        data_prior_sd = sd_reporting_rate_3,
        data_posteriors = mmmstan_regions_3_mean$summary$reporting_rate,
        regions = toupper(names(list_regions_3)),
        bar_width = 0.75,
        position_dodge = 0.8,
        width = 90,
        height = 60,
        dpi = 300,
        file_type = ".png"
      ),
      format = "file"
    )
  ),
  # Plot bar regions 3 released by year ----------------------------------------
  list(
    tar_target(
      bar_regions_3_released_by_year,
      plot_released_by_year(
        plot_name = "bar-regions-3-released-by-year",
        data = tag_data,
        size_range = 400:800,
        year_start = year_start,
        year_xmin = year_start,
        year_xmax = 2020,
        regions = toupper(names(list_regions_3)),
        bar_width = 0.75,
        width = 90,
        height = 60,
        dpi = 300,
        file_type = ".png"
      ),
      format = "file"
    )
  ),
  # Plot bar regions 3 released by size ----------------------------------------
  list(
    tar_target(
      bar_regions_3_released_by_size,
      plot_released_by_size(
        plot_name = "bar-regions-3-released-by-size",
        data = tag_data,
        regions = toupper(names(list_regions_3)),
        size_range = 200:1000,
        year_range = 1979:2017,
        binwidth = 10,
        width = 190,
        height = 100,
        dpi = 300,
        file_type = ".png"
      ),
      format = "file"
    )
  ),
  # Plot bar regions 3 recovered by year ---------------------------------------
  list(
    tar_target(
      bar_regions_3_recovered_by_year,
      plot_recovered_by_year(
        plot_name = "bar-regions-3-recovered-by-year",
        data = tag_data,
        size_range = 400:800, # Released size
        year_range = 1979:2017,
        year_xmin = 1979,
        year_xmax = 2020,
        regions = toupper(names(list_regions_3)),
        bar_width = 0.75,
        width = 190,
        height = 100,
        dpi = 300,
        file_type = ".png"
      ),
      format = "file"
    )
  ),
  # Plot bar regions 3 duration at liberty -------------------------------------
  list(
    tar_target(
      bar_regions_3_duration_at_liberty, # Based on days_liberty
      plot_duration_at_liberty(          # Model uses duration in steps
        plot_name = "bar-regions-3-duration-at-liberty",
        data = tag_data,
        size_range = 400:800, # Released size
        year_range = 1979:2017,
        regions = toupper(names(list_regions_3)),
        binwidth = 30,
        width = 190,
        height = 100,
        dpi = 300,
        file_type = ".png"
      ),
      format = "file"
    )
  ),
  # Plot map regions 3 released recovered --------------------------------------

  # Copied from sablefish-data/ to preserve data privacy

  # Plot abundance exchange ----------------------------------------------------
  list(
    tar_target(
      bar_abundance_exchange,
      plot_abundance(
        data = abundance_exchange,
        plot_name = "bar-abundance-exchange",
        x_axis_label = "Year",
        y_axis_label = "Abundance exchange (millions)",
        toptop = "bcak",
        topbottom = "akbc",
        bottomtop = "ccbc",
        bottombottom = "bccc",
        toptop_annotation = "AK",
        topbottom_annotation = "BC",
        bottomtop_annotation = "BC",
        bottombottom_annotation = "CC",
        linewidth_hline = 0.5,
        linewidth_error = 0.5,
        x_limits = c(1978, 2020),
        y_limits_top = c(-20, 20),
        y_limits_bottom = c(-10, 80),
        y_limits_top_breaks = round(seq(-20, 20, 10), 0),
        y_limits_bottom_breaks = round(seq(-10, 80, 10), 0),
        relative_panel_height = c(40, 90),
        x_annotation = 2019,
        y_annotation = 8,
        width = 190,
        height = 140,
        dpi = figure_dpi,
        file_type = figure_ext
      ),
      format = "file"
    )
  ),
  # Plot percent attributable --------------------------------------------------
  list(
    tar_target(
      bar_percent_attributable,
      plot_abundance(
        data = percent_attributable,
        plot_name = "bar-percent-attributable",
        y_axis_label = "Abundance proportion attributable to movement",
        toptop = "bcak",
        topbottom = "akbc",
        bottomtop = "ccbc",
        bottombottom = "bccc",
        toptop_annotation = "AK",
        topbottom_annotation = "BC",
        bottomtop_annotation = "BC",
        bottombottom_annotation = "CC",
        linewidth_hline = 0.5,
        linewidth_error = 0.5,
        x_limits = c(1978, 2020),
        y_limits_top = c(-0.6, 0.2),
        y_limits_bottom = c(-0.2, 0.8),
        y_limits_top_breaks = round(seq(-0.6, 0.2, 0.2), 1),
        y_limits_bottom_breaks = round(seq(-0.2, 0.8, 0.2), 1),
        relative_panel_height = c(0.8, 1),
        x_annotation = 2019,
        y_annotation = 0.1,
        width = 190,
        height = 140,
        dpi = figure_dpi,
        file_type = figure_ext
      ),
      format = "file"
    )
  ),
  list()
)
